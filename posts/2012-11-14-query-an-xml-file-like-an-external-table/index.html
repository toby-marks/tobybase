<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Toby Marks">
    <meta name="description" content="My tech blog">
    <meta name="keywords" content="oracle,infolob,blog,consultant,developer,tuning,exadata,personal">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How To Use SQL to Query an XML Document Using Oracle External Tables"/>
<meta name="twitter:description" content="Oracle&rsquo;s external table feature allows you to treat structured files on the database server as tables for query and DML purposes. To use an example from the linked documentation, a tab-delimited file like this:
56 november, 15, 1980 baker mary alice 09/01/2004 87 december, 20, 1970 roper lisa marie 01/01/1999 &hellip;could be queried like this:
SELECT employee_number, employee_first_name, substr(employee_middle_name, 1, 1), employee_last_name, employee_hire_date, to_date(employee_dob,&#39;month, dd, yyyy&#39;) FROM employees; After defining the external table like this:"/>

    <meta property="og:title" content="How To Use SQL to Query an XML Document Using Oracle External Tables" />
<meta property="og:description" content="Oracle&rsquo;s external table feature allows you to treat structured files on the database server as tables for query and DML purposes. To use an example from the linked documentation, a tab-delimited file like this:
56 november, 15, 1980 baker mary alice 09/01/2004 87 december, 20, 1970 roper lisa marie 01/01/1999 &hellip;could be queried like this:
SELECT employee_number, employee_first_name, substr(employee_middle_name, 1, 1), employee_last_name, employee_hire_date, to_date(employee_dob,&#39;month, dd, yyyy&#39;) FROM employees; After defining the external table like this:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://tobybase.com/posts/2012-11-14-query-an-xml-file-like-an-external-table/" />
<meta property="article:published_time" content="2012-11-14T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2017-02-22T00:00:00&#43;00:00"/>


    
      <base href="http://tobybase.com/posts/2012-11-14-query-an-xml-file-like-an-external-table/">
    
    <title>
  How To Use SQL to Query an XML Document Using Oracle External Tables ¬∑ üë®üèª‚Äçüíª Tobybase
</title>

    
      <link rel="canonical" href="http://tobybase.com/posts/2012-11-14-query-an-xml-file-like-an-external-table/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css" integrity="sha256-oSrCnRYXvHG31SBifqP2PM1uje7SJUyX0nTwO2RJV54=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="http://tobybase.com/css/coder.min.28d751104f30c16da1aa1bb04015cbe662cacfe0d1b01af4f2240ad58580069c.css" integrity="sha256-KNdREE8wwW2hqhuwQBXL5mLKz&#43;DRsBr08iQK1YWABpw=" crossorigin="anonymous" media="screen" />
    

    

    

    
      <link rel="stylesheet" href="http://tobybase.com/css/custom.css">
    

    <link rel="icon" type="image/png" href="http://tobybase.com/img/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="http://tobybase.com/img/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.55.6" />
  </head>

  <body class=" ">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="http://tobybase.com">
      üë®üèª‚Äçüíª Tobybase
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="http://tobybase.com/posts/">Blog</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="http://tobybase.com/links/">Links</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="http://tobybase.com/about/">About</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">How To Use SQL to Query an XML Document Using Oracle External Tables</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2012-11-14T00:00:00Z'>
                November 14, 2012
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              3 minutes read
            </span>
          </div>
          <div class="categories">
  <i class="fas fa-folder"></i>
    <a href="http://tobybase.com/categories/database/">Database</a></div>

          <div class="tags">
  <i class="fas fa-tag"></i>
    <a href="http://tobybase.com/tags/oracle/">oracle</a>
      <span class="separator">‚Ä¢</span>
    <a href="http://tobybase.com/tags/xml/">xml</a>
      <span class="separator">‚Ä¢</span>
    <a href="http://tobybase.com/tags/sql/">sql</a>
      <span class="separator">‚Ä¢</span>
    <a href="http://tobybase.com/tags/external-tables/">external tables</a></div>

        </div>
      </header>

      <div>
        <p>Oracle&rsquo;s <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28319/et_concepts.htm">external table feature</a> allows you to treat structured files on the database server as tables for query and DML purposes. To use an example from the linked documentation, a tab-delimited file like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">56   november, 15, 1980  baker             mary       alice     09/01/2004
87   december, 20, 1970  roper             lisa       marie     01/01/1999</pre></div>
<p>&hellip;could be queried like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-SQL" data-lang="SQL"><span style="font-weight:bold">SELECT</span> employee_number,
       employee_first_name,
       substr(employee_middle_name, 1, 1),
       employee_last_name,
       employee_hire_date,
       to_date(employee_dob,<span style="font-style:italic">&#39;month, dd, yyyy&#39;</span>)
  <span style="font-weight:bold">FROM</span> employees;</code></pre></div>
<p>After defining the external table like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">    <span style="font-weight:bold">CREATE</span> <span style="font-weight:bold">TABLE</span> employees
           (employee_number      CHAR(5),
            employee_dob         CHAR(20),
            employee_last_name   CHAR(20),
            employee_first_name  CHAR(15),
            employee_middle_name CHAR(15),
            employee_hire_date   DATE)
         ORGANIZATION <span style="font-weight:bold">EXTERNAL</span>
           (<span style="font-weight:bold">TYPE</span> ORACLE_LOADER
            <span style="font-weight:bold">DEFAULT</span> DIRECTORY def_dir1
            <span style="font-weight:bold">ACCESS</span> <span style="font-weight:bold">PARAMETERS</span>
              (RECORDS DELIMITED <span style="font-weight:bold">BY</span> NEWLINE
               FIELDS (employee_number      CHAR(2),
                       employee_dob         CHAR(20),
                       employee_last_name   CHAR(18),
                       employee_first_name  CHAR(11),
                       employee_middle_name CHAR(11),
                       employee_hire_date   CHAR(10) date_format DATE mask <span style="font-style:italic">&#34;mm/dd/yyyy&#34;</span>
                      )
              )
            <span style="font-weight:bold">LOCATION</span> (<span style="font-style:italic">&#39;info.dat&#39;</span>)
           );</code></pre></div>
<p>Assuming of course that the file&rsquo;s name is <code>info.dat</code>, and its path on the filesystem has already been created as a directory object <code>DEF_DIR1</code> in the database.</p>

<p>A similar technique exists for querying simple XML files, taking advantage of <a href="http://docs.oracle.com/cd/E11882_01/appdev.112/e23094/toc.htm">Oracle&rsquo;s XML DB</a> features. _HT to <a href="https://forums.oracle.com/forums/profile.jspa?userID=695787">odie_63</a> on the XML DB forums for introducing me to this method._</p>

<p>Suppose you have a simple XML file (elements, but no attributes; no complex column types - it could work for the preceding, but I&rsquo;m not sure) like so.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">    <span style="font-weight:bold">&lt;Employees&gt;</span>
        <span style="font-weight:bold">&lt;Employee&gt;</span>
            <span style="font-weight:bold">&lt;id&gt;</span>1234<span style="font-weight:bold">&lt;/id&gt;</span>
            <span style="font-weight:bold">&lt;lastname&gt;</span>Jetson<span style="font-weight:bold">&lt;/lastname&gt;</span>
            <span style="font-weight:bold">&lt;firstname&gt;</span>George<span style="font-weight:bold">&lt;/firstname&gt;</span>
            <span style="font-weight:bold">&lt;department&gt;</span>10<span style="font-weight:bold">&lt;/department&gt;</span>
            <span style="font-weight:bold">&lt;salary&gt;</span>50000.00<span style="font-weight:bold">&lt;/salary&gt;</span>
        <span style="font-weight:bold">&lt;/Employee&gt;</span>
        <span style="font-weight:bold">&lt;Employee&gt;</span>
            <span style="font-weight:bold">&lt;id&gt;</span>1235<span style="font-weight:bold">&lt;/id&gt;</span>
            <span style="font-weight:bold">&lt;lastname&gt;</span>Crackorn<span style="font-weight:bold">&lt;/lastname&gt;</span>
            <span style="font-weight:bold">&lt;firstname&gt;</span>James<span style="font-weight:bold">&lt;/firstname&gt;</span>
            <span style="font-weight:bold">&lt;department&gt;</span>10<span style="font-weight:bold">&lt;/department&gt;</span>
            <span style="font-weight:bold">&lt;salary&gt;</span>40000.00<span style="font-weight:bold">&lt;/salary&gt;</span>
        <span style="font-weight:bold">&lt;/Employee&gt;</span>
        <span style="font-weight:bold">&lt;Employee&gt;</span>
            <span style="font-weight:bold">&lt;id&gt;</span>1236<span style="font-weight:bold">&lt;/id&gt;</span>
            <span style="font-weight:bold">&lt;lastname&gt;</span>Hoffman<span style="font-weight:bold">&lt;/lastname&gt;</span>
            <span style="font-weight:bold">&lt;firstname&gt;</span>Burl<span style="font-weight:bold">&lt;/firstname&gt;</span>
            <span style="font-weight:bold">&lt;department&gt;</span>20<span style="font-weight:bold">&lt;/department&gt;</span>
            <span style="font-weight:bold">&lt;salary&gt;</span>75000.00<span style="font-weight:bold">&lt;/salary&gt;</span>
        <span style="font-weight:bold">&lt;/Employee&gt;</span>
    <span style="font-weight:bold">&lt;/Employees&gt;</span></code></pre></div>
<p>Place it on the database server in a readable directory, e.g. <code>/home/oracle</code>. Name it <code>employees.xml</code>.</p>

<p>Now execute the following in SQL*Plus:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">    <span style="font-weight:bold">SQL</span>&gt; <span style="font-weight:bold">CREATE</span> <span style="font-weight:bold">OR</span> <span style="font-weight:bold">REPLACE</span> DIRECTORY XML_DIR <span style="font-weight:bold">AS</span> <span style="font-style:italic">&#39;/home/oracle&#39;</span>;

    <span style="font-weight:bold">SQL</span>&gt; <span style="font-weight:bold">CREATE</span> <span style="font-weight:bold">OR</span> <span style="font-weight:bold">REPLACE</span> <span style="font-weight:bold">VIEW</span> employees_v <span style="font-weight:bold">AS</span>
    <span style="font-weight:bold">SELECT</span> *
    <span style="font-weight:bold">FROM</span> XMLTable(<span style="font-style:italic">&#39;/Employees/Employee&#39;</span>
            passing xmltype(
                     bfilename(<span style="font-style:italic">&#39;XML_DIR&#39;</span>,<span style="font-style:italic">&#39;employees.xml&#39;</span>)
                    , nls_charset_id(<span style="font-style:italic">&#39;AL32UTF8&#39;</span>)
                    )
            columns id           number path <span style="font-style:italic">&#39;id&#39;</span>
                  , lastname     varchar2(30) path <span style="font-style:italic">&#39;lastname&#39;</span>
                  , firstname    varchar2(30) path <span style="font-style:italic">&#39;firstname&#39;</span>
                  , department   number path <span style="font-style:italic">&#39;department&#39;</span>
                  , salary       number path <span style="font-style:italic">&#39;salary&#39;</span>
           );

    <span style="font-weight:bold">SQL</span>&gt; <span style="font-weight:bold">SELECT</span> * <span style="font-weight:bold">FROM</span> employees_v;
    ID   LASTNAME FIRSTNAME DEPARTMENT SALARY
    <span style="font-style:italic">---- -------- --------- ---------- ------
</span><span style="font-style:italic"></span>    1234 Jetson   George    10         50000    
    1235 Crackorn James     10         40000
    1236 Hoffman  Burl      20         75000</code></pre></div>
<p>You can modify construction of the view to read from multiple files by using a simple <code>UNION</code> operator, or you can make the source filename dynamic so you can switch datasets at runtime. Here&rsquo;s how you might do something like that:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">    <span style="font-weight:bold">SQL</span>&gt; <span style="font-weight:bold">CREATE</span> <span style="font-weight:bold">OR</span> <span style="font-weight:bold">REPLACE</span> <span style="font-weight:bold">VIEW</span> employees_v <span style="font-weight:bold">AS</span>
    <span style="font-weight:bold">SELECT</span> *
    <span style="font-weight:bold">FROM</span> XMLTable(<span style="font-style:italic">&#39;/Employees/Employee&#39;</span>
            passing xmltype(
                     bfilename(<span style="font-style:italic">&#39;XML_DIR&#39;</span>, userenv(<span style="font-style:italic">&#39;CLIENT_INFO&#39;</span>))
                    , nls_charset_id(<span style="font-style:italic">&#39;AL32UTF8&#39;</span>)
                    )
            columns id           number path <span style="font-style:italic">&#39;id&#39;</span>
                  , lastname     varchar2(30) path <span style="font-style:italic">&#39;lastname&#39;</span>
                  , firstname    varchar2(30) path <span style="font-style:italic">&#39;firstname&#39;</span>
                  , department   number path <span style="font-style:italic">&#39;department&#39;</span>
                  , salary       number path <span style="font-style:italic">&#39;salary&#39;</span>
           );</code></pre></div>
<p>Then at runtime, specify the file you want to use like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plpgsql" data-lang="plpgsql">    SQL&gt; exec dbms_application_info.set_client_info(<span style="font-style:italic">&#39;employees_01.xml&#39;</span>);

    SQL&gt; <span style="font-weight:bold">SELECT</span> * <span style="font-weight:bold">FROM</span> employees_v;
    ID   LASTNAME FIRSTNAME DEPARTMENT SALARY
    <span style="font-style:italic">---- -------- --------- ---------- ------
</span><span style="font-style:italic"></span>    1234 Jetson   George    10         50000    
    1235 Crackorn James     10         40000
    1236 Hoffman  Burl      20         75000

    SQL&gt; exec dbms_application_info.set_client_info(<span style="font-style:italic">&#39;employees_02.xml&#39;</span>);

    SQL&gt; <span style="font-weight:bold">SELECT</span> * <span style="font-weight:bold">FROM</span> employees_v;
    ID   LASTNAME FIRSTNAME DEPARTMENT SALARY
    <span style="font-style:italic">---- -------- --------- ---------- ------
</span><span style="font-style:italic"></span>    1234 Ringwald Malory    30         63000    
    1235 Dulles   Bob       10         100000
    1236 Stein    Frank     50         55000</code></pre></div>
<p>Why might this be useful? Suppose you have an arbitrary number of identically structured XML files in a directory that you want to import into a relational database table. Using a shell script you can, for each file in the directory,</p>

<ul>
<li>log in to SQL*Plus</li>
<li>set the <code>CLIENT_INFO</code> variable to the name of the current file</li>
<li>perform a simple insert into your table reading all records from the view</li>
</ul>

<p>You might even create a cron job to monitor a particular directory for new XML files, processing them into tables and then deleting or archiving the files when done.</p>

      </div>

      <footer>
        


        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "tobybase-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </footer>
    </article>

    
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
      <p>Oracle Database Developer and Performance Tuner, specialized on the Exadata platform. Working for Infolob from Irving, Texas. Life is beautiful. üåºüêù</p>
    
     ¬© 2019
    
    
  </section>
</footer>

    </main>

    

  </body>

</html>
